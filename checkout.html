<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECHSpec Check - Checkout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f2f2f2;
            color: #1f2937;
            padding: 0;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #ffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h4 {
            color: #000;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .cart-funct {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .cart-image {
            position: relative;
            cursor: pointer;
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .search-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            padding: 8px 18px;
            width: 300px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .search-container input {
            border: none;
            background: transparent;
            padding: 5px;
            width: 100%;
            outline: none;
            font-size: 15px;
        }
        
        /* Navigation */
        .nav-links {
            position: relative;
        }
        
        #nav-check {
            display: none;
        }
        
        .nav-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-between;
            width: 35px;
            height: 25px;
            cursor: pointer;
        }
        
        .nav-toggle span {
            height: 3px;
            width: 100%;
            background-color: #333;
            border-radius: 3px;
        }
        
        .nav-list {
            display: flex;
            gap: 25px;
            list-style: none;
            width: 550px;
            justify-content: center;
        }
        
        .nav-list li a {
            text-decoration: none;
            color: #000;
            font-weight: 500;
            transition: color 0.3s;
            font-size: 16px;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .nav-list li a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .socials {
            display: flex;
            gap: 12px;
            margin-left: 25px;
        }
        
        .socials i {
            font-size: 22px;
            color: white;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .socials i:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        /* Main content */
        .main-content {
            padding: 25px;
            flex: 1;
        }
        
        .checkout-container {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .checkout-form {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .order-summary {
            width: 350px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            align-self: flex-start;
            position: relative;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E9C46A;
            color: #1f2937;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2A9D8F;
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .payment-option.selected {
            border-color: #2A9D8F;
            background-color: rgba(42, 157, 143, 0.05);
        }
        
        .payment-option input {
            margin: 0;
        }
        
        .payment-option label {
            font-weight: 600;
            cursor: pointer;
            margin: 0;
        }
        
        .payment-option img {
            height: 24px;
            margin-left: auto;
        }
        
        .pep-store-info {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .pep-store-info a {
            color: #2A9D8F;
            text-decoration: none;
        }
        
        .pep-store-info a:hover {
            text-decoration: underline;
        }
        
        .order-item {
            display: flex;
            gap: 15px;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .order-item img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .order-item-details {
            flex-grow: 1;
        }
        
        .order-item-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 6px;
        }
        
        .order-item-price {
            color: #2A9D8F;
            font-weight: 700;
            font-size: 16px;
        }
        
        .order-item-quantity {
            color: #6b7280;
            font-size: 14px;
        }
        
        .order-summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .discount-line {
            color: #10b981;
            font-weight: 600;
        }
        
        .free-delivery {
            color: #10b981;
            font-weight: 600;
        }
        
        .order-total {
            margin-top: 20px;
            font-weight: 700;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: #2A9D8F;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            margin-top: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: #1a936f;
        }
        
        .checkout-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        /* New styles for tracking link modal */
        .tracking-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .tracking-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalPopIn 0.5s ease-out;
        }
        
        @keyframes modalPopIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .tracking-modal h2 {
            color: #2A9D8F;
            margin-bottom: 15px;
        }
        
        .tracking-link {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            word-break: break-all;
            border: 2px dashed #2A9D8F;
        }
        
        .tracking-link a {
            color: #2A9D8F;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
        }
        
        .tracking-link a:hover {
            text-decoration: underline;
        }
        
        .modal-btn {
            background: #2A9D8F;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        .modal-btn:hover {
            background: #1a936f;
        }
        
        .modal-btn.secondary {
            background: #6b7280;
        }
        
        .modal-btn.secondary:hover {
            background: #4b5563;
        }
        
        .debug-toggle {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .debug-info {
            display: none;
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border-left: 4px solid #2A9D8F;
        }
        
        /* Special Offer Banner */
        .special-offer {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(5, 150, 105, 0.3);
        }
        
        .special-offer i {
            font-size: 20px;
        }
        
        .special-offer-text {
            flex-grow: 1;
        }
        
        .special-offer strong {
            font-size: 16px;
        }
        
        /* New styles for promo code section */
        .promo-code-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #2A9D8F;
        }
        
        .promo-code-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .promo-code-input-group {
            display: flex;
            gap: 10px;
        }
        
        .promo-code-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .apply-promo-btn {
            background: #2A9D8F;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .apply-promo-btn:hover {
            background: #1a936f;
        }
        
        .apply-promo-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .promo-message {
            margin-top: 10px;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 4px;
            display: none;
        }
        
        .promo-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .promo-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .promo-discount-line {
            color: #10b981;
            font-weight: 600;
        }
        
        /* Footer */
        .footer {
            background: #333;
            color: white;
            padding: 40px 20px;
            margin-top: auto;
        }
        
        .footer-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-section {
            flex: 1;
            min-width: 250px;
            margin-bottom: 30px;
        }
        
        .footer-section h3 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .footer-section p, .footer-section a {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
            display: block;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-section a:hover {
            color: white;
            text-decoration: underline;
        }
        
        .footer-social {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .footer-social a {
            font-size: 20px;
            color: white;
            background-color: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .footer-social a:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 30px;
            font-size: 14px;
        }
        
        /* Responsive Design */
        @media (max-width: 968px) {
            .checkout-container {
                flex-direction: column;
            }
            
            .order-summary {
                width: 100%;
            }
            
            .header {
                flex-wrap: wrap;
            }
            
            .nav-list {
                width: 100%;
            }
            
            .search-container {
                width: 100%;
                order: 3;
                margin-top: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .nav-toggle {
                display: flex;
            }
            
            .nav-list {
                display: none;
                position: absolute;
                top: 105px;
                left: -20px;
                width: 382px;
                background: #ffff;
                flex-direction: column;
                padding: 20px;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                gap: 15px;
            }
            
            #nav-check:checked ~ .nav-list {
                display: flex;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .footer-section {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }
            
            .checkout-form, .order-summary {
                padding: 20px;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .special-offer {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <!-----Start of Nav-bar--->
        <div class="nav-links">
            <input type="checkbox" id="nav-check">
            <label for="nav-check" class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </label>
            <ul class="nav-list">
                <li><a href="home.html">Home</a></li>
                <li><a href="#">Blog</a></li>
                <li><a href="#">About us</a></li>
                <li><a href="#">Contact Us</a></li>
            </ul>
        </div>
        <!--End of nav bar-->  
        
        <h4>TECHSpec Check</h4>
        
        <div class="cart-funct">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search products...">
                <i class="fas fa-search" style="color:#333;"></i>
            </div>
            <div class="cart-image">
                <a href="homev7.html">
                    <i class="fas fa-shopping-cart" style="font-size:24px; color:#333;"></i> 
                </a>
                <div class="cart-count" id="count">0</div>
            </div>
        </div> 
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Tracking Link Modal -->
    <div class="tracking-modal" id="tracking-modal">
        <div class="tracking-modal-content">
            <h2>ðŸŽ‰ Order Placed Successfully!</h2>
            <p>Your order has been confirmed and is being processed.</p>
            <p><strong>Reference Number:</strong> <span id="modal-reference"></span></p>
            
            <div class="tracking-link">
                <p>Track your order status:</p>
                <a href="#" id="tracking-link">Click here to track your order</a>
            </div>
            
            <p>A confirmation email has been sent to your email address.</p>
            
            <button class="modal-btn" onclick="closeTrackingModal()">Continue Shopping</button>
            <button class="modal-btn secondary" onclick="goToTracking()">Track Order Now</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h1 style="margin: 20px 0 30px; text-align: center; color: #1f2937;">Checkout</h1>
        
        <!-- Debug Button -->
        <button class="debug-toggle" onclick="toggleDebug()">Show Debug Info</button>
        <div class="debug-info" id="debug-info"></div>
        
        <div class="checkout-container">
            <!-- Checkout Form -->
            <div class="checkout-form">
                <h2 class="section-title">Customer Information</h2>
                
                <form id="checkout-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first-name">First Name</label>
                            <input type="text" id="first-name" required>
                        </div>
                        <div class="form-group">
                            <label for="last-name">Last Name</label>
                            <input type="text" id="last-name" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Cell Phone Number</label>
                        <input type="tel" id="phone" required>
                    </div>
                    
                    <h2 class="section-title" style="margin-top: 40px;">Delivery Information</h2>
                    
                    <div class="form-group">
                        <label for="pep-code">Nearest PEP Store Code</label>
                        <input type="text" id="pep-code" placeholder="e.g., PEP1234" required>
                        <div class="pep-store-info">
                            <p>Don't know your nearest PEP Store? <a href="https://www.pepstores.com/store-locator/" target="_blank">Find your nearest PEP store</a></p>
                            <p>We use Paxi for delivery. Your order will be delivered to the PEP store you specify.</p>
                        </div>
                    </div>
                    
                    <h2 class="section-title" style="margin-top: 40px;">Payment Method</h2>
                    
                    <div class="payment-option" id="paypal-option">
                        <input type="radio" id="paypal" name="payment-method" value="paypal" checked>
                        <label for="paypal">PayPal</label>
                        <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_111x69.jpg" alt="PayPal">
                    </div>
                    
                    <button type="submit" class="checkout-btn" id="place-order-btn">Place Order</button>
                </form>
            </div>
            
            <!-- Order Summary -->
            <div class="order-summary">
                <h2 class="section-title">Order Summary</h2>
                
                <!-- Special Offer Banner -->
                <div class="special-offer" id="special-offer-banner" style="display: none;">
                    <i class="fas fa-gift"></i>
                    <div class="special-offer-text">
                        <strong>Special Offer!</strong> Orders over R1500 get 15% off and free delivery!
                    </div>
                </div>
                
                <!-- Promo Code Section -->
                <div class="promo-code-section">
                    <div class="promo-code-title">
                        <i class="fas fa-tag"></i> Promo Code
                    </div>
                    <div class="promo-code-input-group">
                        <input type="text" class="promo-code-input" id="promo-code" placeholder="Enter promo code">
                        <button class="apply-promo-btn" id="apply-promo-btn">Apply</button>
                    </div>
                    <div class="promo-message" id="promo-message"></div>
                </div>
                
                <div id="order-items"></div>
                <div id="order-summary-details"></div>
                <div class="order-total">
                    <span>Total:</span>
                    <span id="order-total">R 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
       <div class="footer-content">
           <div class="footer-section">
               <h3>TECHSpec Check</h3>
               <p>Your trusted partner for quality tech products and accessories. We offer the latest gadgets at competitive prices.</p>
               <div class="footer-social">
                   <a href="#"><i class="fab fa-facebook-f"></i></a>
                   <a href="#"><i class="fab fa-twitter"></i></a>
                   <a href="#"><i class="fab fa-instagram"></i></a>
                   <a href="#"><i class="fab fa-linkedin-in"></i></a>
               </div>
           </div>
           
           <div class="footer-section">
               <h3>Quick Links</h3>
               <a href="homev7.html">Home</a>
               <a href="#">About Us</a>
               <a href="#">Send Complaint</a>
               <a href="#">Blog</a>
           </div>
           
           <div class="footer-section">
               <h3>Contact Info</h3>
               <p><i class="fas fa-map-marker-alt"></i> 123 Tech Street, Johannesburg</p>
               <p><i class="fas fa-phone"></i> +27 11 123 4567</p>
               <p><i class="fas fa-envelope"></i> info@techspeccheck.co.za</p>
           </div>
           
           <div class="footer-section">
               <h3>Newsletter</h3>
               <p>Subscribe to our newsletter for the latest product updates and special offers.</p>
               <form>
                   <input type="email" placeholder="Your Email" style="padding:10px; width:100%; border-radius:5px; border:none; margin-bottom:10px;">
                   <button type="submit" style="padding:10px 15px; background:white; color:#2A9D8F; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Subscribe</button>
               </form>
           </div>
       </div>
       
       <div class="footer-bottom">
           <p>&copy; 2023 TECHSpec Check. All rights reserved.</p>
       </div>
    </div>
<script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
    
    const supabaseUrl = 'https://wtiqgcsucpcqgyqutcmq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0aXFnY3N1Y3BjcWd5cXV0Y21xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MzMzNDYsImV4cCI6MjA2MjAwOTM0Nn0.MtXBQ9qXTPwWEBh8l5jYh_zDYKkYyiUc2WwaA5wrtpE';
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    // EmailJS configuration
    const EMAILJS_SERVICE_ID = 'service_4gnbbyk';
    const EMAILJS_TEMPLATE_ID = 'template_yzeuxf7';
    const EMAILJS_PUBLIC_KEY = '7EubRJ1uO-BIK3faQ';
    
    // Debug functions
    function logDebug(message) {
        const debugInfo = document.getElementById('debug-info');
        debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
        console.log(message);
    }

    function toggleDebug() {
        const debugInfo = document.getElementById('debug-info');
        debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    }
    
    // Function to show toast notification
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = isError ? 'toast error' : 'toast';
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 5000);
    }
    
    // Function to generate unique reference number
    function generateReferenceNumber() {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `TSC${timestamp}${random}`;
    }
    
    // Function to format order items for email (using your template structure)
    function formatOrderItemsForEmail(cart) {
        return cart.map(item => {
            const price = typeof item.price === 'string' 
                ? parseFloat(item.price.replace(/[^0-9.-]+/g, "")) 
                : Number(item.price);
            const itemTotal = price * item.quantity;
            
            return `
                <div class="item">
                    <strong>${item.name}</strong><br>
                    Quantity: ${item.quantity} Ã— R ${price.toFixed(2)}<br>
                    Item Total: R ${itemTotal.toFixed(2)}
                </div>
            `;
        }).join('');
    }
    
    // Function to format order details for tracking display
    function formatOrderDetailsForTracking(cart) {
        if (!cart || cart.length === 0) return 'No items';
        
        let details = '';
        cart.forEach((item, index) => {
            const itemTotal = (item.price * item.quantity) || 0;
            details += `${item.name || 'Unknown Product'} (R${item.price || '0'} x ${item.quantity || '1'})`;
            if (index < cart.length - 1) details += ', ';
        });
        
        return details;
    }
    
    // Function to analyze cart for admin data - SIMPLIFIED VERSION
    function analyzeCartForAdmin(cart) {
        // Calculate category distribution
        const categoryData = {};
        
        cart.forEach(item => {
            const category = item.category || 'Other';
            categoryData[category] = (categoryData[category] || 0) + item.quantity;
        });
        
        return {
            category_data: categoryData,
            total_items: cart.reduce((sum, item) => sum + item.quantity, 0),
            unique_products: cart.length
        };
    }
    
    // Function to send confirmation email using EmailJS
    async function sendOrderConfirmationEmail(orderData, cart) {
        try {
            logDebug('Starting email sending process with EmailJS...');
            
            // Format the order date nicely
            const orderDate = new Date().toLocaleDateString('en-ZA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Create tracking link - use your GitHub Pages URL
            const trackingLink = `https://mathonzi04.github.io/PICKTOCART01/track_order.html?ref=${orderData.reference_number}`;
            
            // Prepare email parameters matching your template
            const templateParams = {
                customer_name: `${orderData.customer_first_name} ${orderData.customer_last_name}`,
                customer_email: orderData.customer_email,
                reference_number: orderData.reference_number,
                order_date: orderDate,
                pep_store_code: orderData.pep_store_code,
                payment_method: orderData.payment_method,
                items: formatOrderItemsForEmail(cart),
                subtotal: orderData.subtotal.toFixed(2),
                discount: orderData.discount ? orderData.discount.toFixed(2) : '0.00',
                delivery_fee: orderData.delivery_fee.toFixed(2),
                total: orderData.total.toFixed(2),
                tracking_link: trackingLink
            };
            
            logDebug('Email template parameters prepared');
            logDebug(`Tracking link: ${trackingLink}`);
            
            // Load EmailJS library if not already loaded
            if (typeof emailjs === 'undefined') {
                logDebug('Loading EmailJS library...');
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
                    script.onload = () => {
                        logDebug('EmailJS library loaded successfully');
                        resolve();
                    };
                    script.onerror = () => {
                        logDebug('Failed to load EmailJS library');
                        reject(new Error('Failed to load EmailJS'));
                    };
                    document.head.appendChild(script);
                });
            }
            
            // Initialize EmailJS
            logDebug('Initializing EmailJS...');
            emailjs.init(EMAILJS_PUBLIC_KEY);
            logDebug('EmailJS initialized');
            
            // Send email
            logDebug('Sending email via EmailJS...');
            const result = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
            logDebug('Email sent successfully via EmailJS');
            
            return { 
                success: true, 
                result,
                trackingLink: trackingLink
            };
            
        } catch (error) {
            logDebug('EmailJS sending failed: ' + error.toString());
            logDebug('Error details: ' + JSON.stringify(error));
            return { 
                success: false, 
                error: error,
                nonCritical: true // Email failure shouldn't block order
            };
        }
    }
    
    // Function to update product quantities in database
    async function updateProductQuantities(cart) {
        try {
            logDebug('Starting product quantity update...');
            
            for (const item of cart) {
                logDebug(`Updating product ${item.id} (${item.name}): reducing quantity by ${item.quantity}`);
                
                // Get current product data
                const { data: product, error: fetchError } = await supabase
                    .from('products')
                    .select('quantity')
                    .eq('id', item.id)
                    .single();
                
                if (fetchError) {
                    logDebug(`Error fetching product ${item.id}: ${fetchError.message}`);
                    continue;
                }
                
                // Calculate new quantity
                const newQuantity = Math.max(0, product.quantity - item.quantity);
                
                // Update product quantity
                const { error: updateError } = await supabase
                    .from('products')
                    .update({ quantity: newQuantity })
                    .eq('id', item.id);
                
                if (updateError) {
                    logDebug(`Error updating product ${item.id}: ${updateError.message}`);
                } else {
                    logDebug(`Product ${item.id} updated successfully. New quantity: ${newQuantity}`);
                }
            }
            
            logDebug('Product quantity update completed');
            return { success: true };
            
        } catch (error) {
            logDebug('Error in updateProductQuantities: ' + error.toString());
            return { success: false, error };
        }
    }
    
    // Function to validate and apply promo code
    async function applyPromoCode(promoCode, subtotal) {
        try {
            logDebug(`Validating promo code: ${promoCode}`);
            
            // Check if promo code exists and is valid
            const { data: promoData, error } = await supabase
                .from('promo_codes')
                .select('*')
                .eq('code', promoCode.toUpperCase())
                .gte('expiry_date', new Date().toISOString().split('T')[0])
                .single();
            
            if (error || !promoData) {
                logDebug('Invalid or expired promo code');
                return { 
                    success: false, 
                    message: 'Invalid or expired promo code' 
                };
            }
            
            logDebug(`Valid promo code found: ${promoData.code}, type: ${promoData.discount_type}, value: ${promoData.discount_value}`);
            
            // Calculate discount based on type
            let discountAmount = 0;
            if (promoData.discount_type === 'percentage') {
                discountAmount = subtotal * (promoData.discount_value / 100);
            } else if (promoData.discount_type === 'fixed') {
                discountAmount = Math.min(promoData.discount_value, subtotal);
            }
            
            logDebug(`Calculated discount: R ${discountAmount.toFixed(2)}`);
            
            return {
                success: true,
                discount: discountAmount,
                message: `Promo code applied! ${promoData.discount_type === 'percentage' ? promoData.discount_value + '%' : 'R ' + promoData.discount_value.toFixed(2)} discount added.`,
                promoData: promoData
            };
            
        } catch (error) {
            logDebug('Error applying promo code: ' + error.toString());
            return { 
                success: false, 
                message: 'Error applying promo code' 
            };
        }
    }
    
    // Modal functions
    function showTrackingModal(referenceNumber, trackingLink = '') {
        const modal = document.getElementById('tracking-modal');
        const modalReference = document.getElementById('modal-reference');
        const trackingLinkElement = document.getElementById('tracking-link');
        
        modalReference.textContent = referenceNumber;
        
        // Use provided tracking link or generate one with your GitHub Pages URL
        const finalTrackingLink = trackingLink || `https://mathonzi04.github.io/PICKTOCART01/track_order.html?ref=${referenceNumber}`;
        trackingLinkElement.href = finalTrackingLink;
        trackingLinkElement.textContent = `Track Your Order (Reference: ${referenceNumber})`;
        
        modal.style.display = 'flex';
    }
    
    function closeTrackingModal() {
        const modal = document.getElementById('tracking-modal');
        modal.style.display = 'none';
        // Redirect to home page
        window.location.href = 'home.html';
    }
    
    function goToTracking() {
        const trackingLink = document.getElementById('tracking-link').href;
        window.location.href = trackingLink;
    }

    document.addEventListener('DOMContentLoaded', function() {
        logDebug('Page loaded - Checkout system ready');
        
        // Global variables for order calculation
        let subtotal = 0;
        let discount = 0;
        let promoDiscount = 0;
        let deliveryFee = 60.00; // R60 Paxi delivery fee
        let appliedPromoCode = null;
        
        // Retrieve cart data from sessionStorage
        const cartData = sessionStorage.getItem('checkoutCart');
        let cart = cartData ? JSON.parse(cartData) : [];
        
        logDebug(`Cart loaded with ${cart.length} items`);
        
        // Update cart count in header
        const cartCount = document.getElementById('count');
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        cartCount.textContent = totalItems;
        
        // Display order items and calculate total
        const orderItemsContainer = document.getElementById('order-items');
        const orderSummaryDetails = document.getElementById('order-summary-details');
        const orderTotalElement = document.getElementById('order-total');
        const specialOfferBanner = document.getElementById('special-offer-banner');
        
        if (cart.length === 0) {
            orderItemsContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#6b7280;">Your cart is empty</p>';
            orderTotalElement.textContent = 'R 0.00';
            document.getElementById('place-order-btn').disabled = true;
            logDebug('Cart is empty - disabling order button');
            return;
        }
        
        orderItemsContainer.innerHTML = '';
        
        // Fetch product categories from database to ensure we have correct categories
        async function enhanceCartWithCategories(cart) {
            try {
                logDebug('Enhancing cart with product categories...');
                const enhancedCart = [];
                
                for (const item of cart) {
                    // If item already has category, use it
                    if (item.category) {
                        enhancedCart.push(item);
                        continue;
                    }
                    
                    // Otherwise fetch from database
                    const { data: product, error } = await supabase
                        .from('products')
                        .select('category')
                        .eq('id', item.id)
                        .single();
                    
                    if (error) {
                        logDebug(`Error fetching category for product ${item.id}: ${error.message}`);
                        enhancedCart.push({...item, category: 'Other'});
                    } else {
                        logDebug(`Found category for product ${item.id}: ${product.category}`);
                        enhancedCart.push({...item, category: product.category || 'Other'});
                    }
                }
                
                return enhancedCart;
            } catch (error) {
                logDebug('Error enhancing cart with categories: ' + error.toString());
                return cart.map(item => ({...item, category: item.category || 'Other'}));
            }
        }
        
        // Enhance cart with categories before processing
        enhanceCartWithCategories(cart).then(enhancedCart => {
            cart = enhancedCart;
            processCartDisplay();
        });
        
        function processCartDisplay() {
            cart.forEach(item => {
                const price = typeof item.price === 'string' 
                    ? parseFloat(item.price.replace(/[^0-9.-]+/g, "")) 
                    : Number(item.price);
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;
                
                const orderItem = document.createElement('div');
                orderItem.classList.add('order-item');
                orderItem.innerHTML = `
                    <img src="${item.image_url}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/70x70?text=Product'">
                    <div class="order-item-details">
                        <div class="order-item-name">${item.name}</div>
                        <div class="order-item-price">R ${price.toFixed(2)}</div>
                        <div class="order-item-quantity">Quantity: ${item.quantity}</div>
                        <div class="order-item-category" style="font-size: 12px; color: #6b7280;">Category: ${item.category || 'Other'}</div>
                    </div>
                `;
                
                orderItemsContainer.appendChild(orderItem);
            });
            
            // Check for special offer (15% off and free delivery for orders over R1500)
            if (subtotal > 1500) {
                discount = subtotal * 0.15;
                deliveryFee = 0;
                specialOfferBanner.style.display = 'flex';
                logDebug('Special offer applied: 15% discount and free delivery');
            }
            
            // Function to update order summary display
            function updateOrderSummary() {
                // Calculate total with discount, promo discount and delivery fee
                const total = subtotal - discount - promoDiscount + deliveryFee;
                
                // Display order summary details
                let summaryHTML = `
                    <div class="order-summary-line">
                        <span>Subtotal:</span>
                        <span>R ${subtotal.toFixed(2)}</span>
                    </div>
                `;
                
                if (discount > 0) {
                    summaryHTML += `
                        <div class="order-summary-line discount-line">
                            <span>Discount (15% off):</span>
                            <span>- R ${discount.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (promoDiscount > 0) {
                    summaryHTML += `
                        <div class="order-summary-line promo-discount-line">
                            <span>Promo Discount:</span>
                            <span>- R ${promoDiscount.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                summaryHTML += `
                    <div class="order-summary-line ${deliveryFee === 0 ? 'free-delivery' : ''}">
                        <span>Delivery (Paxi):</span>
                        <span>${deliveryFee === 0 ? 'FREE' : 'R ' + deliveryFee.toFixed(2)}</span>
                    </div>
                `;
                
                orderSummaryDetails.innerHTML = summaryHTML;
                orderTotalElement.textContent = `R ${total.toFixed(2)}`;
                logDebug(`Order total updated: R ${total.toFixed(2)}`);
            }
            
            // Initial update of order summary
            updateOrderSummary();
            
            // Promo code functionality
            document.getElementById('apply-promo-btn').addEventListener('click', async function() {
                const promoCodeInput = document.getElementById('promo-code');
                const promoCode = promoCodeInput.value.trim();
                const promoMessage = document.getElementById('promo-message');
                
                if (!promoCode) {
                    promoMessage.textContent = 'Please enter a promo code';
                    promoMessage.className = 'promo-message promo-error';
                    promoMessage.style.display = 'block';
                    return;
                }
                
                // Disable button while processing
                this.disabled = true;
                this.textContent = 'Applying...';
                
                const result = await applyPromoCode(promoCode, subtotal);
                
                if (result.success) {
                    promoDiscount = result.discount;
                    appliedPromoCode = result.promoData;
                    promoMessage.textContent = result.message;
                    promoMessage.className = 'promo-message promo-success';
                    promoMessage.style.display = 'block';
                    promoCodeInput.disabled = true;
                    this.textContent = 'Applied';
                    this.disabled = true;
                    
                    // Update order summary with promo discount
                    updateOrderSummary();
                    
                    logDebug(`Promo code applied successfully: ${promoCode}, discount: R ${promoDiscount.toFixed(2)}`);
                } else {
                    promoDiscount = 0;
                    appliedPromoCode = null;
                    promoMessage.textContent = result.message;
                    promoMessage.className = 'promo-message promo-error';
                    promoMessage.style.display = 'block';
                    this.disabled = false;
                    this.textContent = 'Apply';
                    
                    // Update order summary without promo discount
                    updateOrderSummary();
                    
                    logDebug(`Promo code application failed: ${result.message}`);
                }
            });
            
            // Handle form submission
            document.getElementById('checkout-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('place-order-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                logDebug('Form submission started');
                
                // Get form values
                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const pepCode = document.getElementById('pep-code').value;
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                
                logDebug(`Customer: ${firstName} ${lastName}, Email: ${email}`);
                
                // Generate reference number
                const referenceNumber = generateReferenceNumber();
                logDebug(`Generated reference number: ${referenceNumber}`);
                
                // Analyze cart for admin data - SIMPLIFIED
                const analyticsData = analyzeCartForAdmin(cart);
                logDebug('Cart analytics generated for admin');
                logDebug('Category data:', analyticsData.category_data);
                
                // Calculate final total
                const total = subtotal - discount - promoDiscount + deliveryFee;
                
                // Create SIMPLIFIED customer order object - only using columns that exist
                const customerOrder = {
                    customer_first_name: firstName,
                    customer_last_name: lastName,
                    customer_email: email,
                    customer_phone: phone,
                    reference_number: referenceNumber,
                    pep_store_code: pepCode,
                    payment_method: paymentMethod,
                    subtotal: subtotal,
                    discount: discount,
                    delivery_fee: deliveryFee,
                    total: total,
                    price_paid: total,
                    items: cart,
                    order_date: new Date().toISOString(),
                    status: 'pending'
                };
                
                // Create SIMPLIFIED package tracking object - only using columns that exist
                const packageTracking = {
                    customer_first_name: firstName,
                    customer_last_name: lastName,
                    customer_email: email,
                    customer_phone: phone,
                    reference_number: referenceNumber,
                    pep_store_code: pepCode,
                    order_details: formatOrderDetailsForTracking(cart),
                    order_approved_date: null,
                    ready_for_delivery_date: null,
                    on_delivery_time: null,
                    reached_destination_time: null,
                    order_picked_message: null,
                    current_status: 'order_received',
                    status_update_date: new Date().toISOString()
                };
                
                try {
                    logDebug('Inserting order into Supabase...');
                    
                    // Insert customer order into Supabase (Table 1)
                    const { data: orderData, error: orderError } = await supabase
                        .from('customer_orders')
                        .insert([customerOrder])
                        .select();
                    
                    if (orderError) {
                        logDebug('Supabase order error: ' + orderError.message);
                        console.error('Error inserting order:', orderError);
                        showToast('Error placing order. Please try again.', true);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Place Order';
                        return;
                    } else {
                        logDebug('Order inserted into Supabase successfully');
                    }
                    
                    // Insert package tracking into Supabase (Table 2)
                    const { data: trackingData, error: trackingError } = await supabase
                        .from('package_tracking')
                        .insert([packageTracking])
                        .select();
                    
                    if (trackingError) {
                        logDebug('Supabase tracking error: ' + trackingError.message);
                        console.error('Error inserting tracking:', trackingError);
                        // Don't fail the order if tracking insertion fails
                    } else {
                        logDebug('Tracking inserted into Supabase successfully');
                    }
                    
                    // Update product quantities in database
                    const updateResult = await updateProductQuantities(cart);
                    if (!updateResult.success) {
                        logDebug('Warning: Product quantity update failed: ' + updateResult.error);
                    }
                    
                    // Send confirmation email with proper error handling
                    logDebug('Attempting to send confirmation email...');
                    const emailResult = await sendOrderConfirmationEmail(customerOrder, cart);
                    
                    if (emailResult.success) {
                        logDebug('Email sent successfully!');
                        logDebug(`Tracking link: ${emailResult.trackingLink}`);
                        
                        // Update the modal with the actual tracking link from email
                        showTrackingModal(referenceNumber, emailResult.trackingLink);
                    } else {
                        logDebug('Email sending failed: ' + (emailResult.error?.message || 'Unknown error'));
                        // Still show success modal even if email fails
                        showTrackingModal(referenceNumber);
                        showToast('Order placed! (Email confirmation failed)', true);
                    }
                    
                    // Clear cart
                    sessionStorage.removeItem('checkoutCart');
                    localStorage.removeItem('techSpecCart');
                    logDebug('Cart cleared from storage');
                    
                    logDebug('Checkout process completed successfully');
                    
                } catch (error) {
                    logDebug('Unexpected error: ' + error.toString());
                    console.error('Error:', error);
                    showToast('Error placing order. Please try again.', true);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Place Order';
                }
            });
            
            // Payment option selection
            document.getElementById('paypal-option').addEventListener('click', function() {
                document.getElementById('paypal').checked = true;
            });
        }
    });
</script>
</body>
</html>